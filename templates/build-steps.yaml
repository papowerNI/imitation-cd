# File: build-steps.yaml

# Parameters: buildToolsRepo, projectLocation, customDevice, and lvVersion
parameters:
  - name: buildToolsRepo
    type: string
  - name: projectLocation
    type: string
  - name: customDevice
    type: string
  - name: lvVersion
    type: string
  - name: bitness
    type: string

steps:
  - ${{ if eq( parameters.bitness, '32' )}}:
    - powershell: Write-Host "##vso[task.setvariable variable=lvPath]C:\Program Files (x86)\National Instruments\LabVIEW ${{ parameters.lvVersion }}"
  - ${{ if eq( parameters.bitness, '64' )}}:
    - powershell: Write-Host "##vso[task.setvariable variable=lvPath]C:\Program Files\National Instruments\LabVIEW ${{ parameters.lvVersion }}"
# 1: Checkout
  - checkout: self
    displayName: Check out Custom Device repository
  - checkout: ${{ parameters.buildToolsRepo }}
    displayName: Check out NI VS Custom Device Build Tools repository

# 2: Temporary step
#  - script: copy "imitation-cd\resources\LabVIEW.ini" "$(lvPath)\LabVIEW.ini"
#    displayName: TEMP - Copy ini file (not needed for final)

# 3: Build all LabVIEW Build Specs
  - script: copy "${{ parameters.buildToolsRepo }}\resources\LabVIEW.exe.config" "${{ parameters.customDevice }}\${{ parameters.projectLocation }}.config"
    displayName: Place lvproj.config next to Project
  - script: LabVIEWCLI -PortNumber 3363 -LabVIEWPath "$(lvPath)\LabVIEW.exe" -AdditionalOperationDirectory "%cd%\${{ parameters.buildToolsRepo }}\lv\operations" -OperationName "ExecuteAllBuildSpecs" -ProjectPath "%cd%\${{ parameters.customDevice }}\${{ parameters.projectLocation }}" -LogFilePath "%cd%\${{ parameters.customDevice }}\lvBuildSpecs.log"
    displayName: Build All Build Specs in ${{ parameters.projectLocation }} for LabVIEW ${{ parameters.lvVersion }}
# 4: Archive
  - powershell: rm -r "nipkg"; mkdir "nipkg"; cp -R "${{ parameters.customDevice }}\Built\*" "nipkg\data\documents\National Instruments\NI VeriStand 2020\Custom Devices\National Instruments"
    displayName: Generate nipkg Files
  - powershell: cp -R -force "${{ parameters.customDevice }}\Built\*" "\\nirvana\temp\papower\LabVIEW ${{ parameters.lvVersion }}"
    displayName: Copying Built Files to \\nirvana Archive