# File: azure-pipelines.yml

# Triggering: if there is a change to one of the branches below, run the pipeline
trigger:
  batch: true
  branches:
    include:
      - main
      - release/*

# Repositories: include build tools (custom device repo included by default)
resources:
  repositories:
    - repository: niveristand-custom-device-build-tools
      type: github
      ref: main
      endpoint: ni (2)
      name: ni/niveristand-custom-device-build-tools

# Shared Pipeline Parameters
parameters:
  - name: agentPool
    type: string
    default: custom-device-temp
  - name: buildTools
    type: string
    default: niveristand-custom-device-build-tools

# Custom Device-specific Parameters
    # Custom Device Name
  - name: customDevice
    type: string
    default: imitation-cd
    # LabVIEW Versions to Build
  - name: lvVersions
    type: object
    default:
      - '2020'
      - '2021'
      - '2023'
    # Custom Device Project Locations
  - name: projectLocations
    type: object
    default:
      - 'Source\TestProject.lvproj'

stages:
  - stage: build

  # Agent Pool:  choose an agent that meets the following requirements
    pool:
      name: ${{ parameters.agentPool }}
      demands:
        - agent.os -equals Windows_NT

    # Currently, no parallelism is needed so far, and no stages are needed so far
    jobs:
      - ${{ each lvVersion in parameters.lvVersions }}:
        - job:
          displayName: Build ${{ parameters.customDevice }} for LabVIEW ${{ lvVersion}}
          steps:
            - template: azure-templates\pre-job-steps.yml # Configure variables, check out repos, Clear cache
              parameters:
                customDevice: ${{ parameters.customDevice }}
                buildTools: ${{ parameters.buildTools }}
                lvVersion: ${{ lvVersion}}
            - template: azure-templates\build-op-steps.yml # config file and build specs
              parameters:
                customDevice: ${{ parameters.customDevice }}
                buildTools: ${{ parameters.buildTools }}
                lvVersion: ${{ lvVersion}}
                projectLocations: ${{ parameters.projectLocations }}
                buildOperation: empty
            - template: azure-templates\post-job-steps.yml # nipkg and archive
              parameters:
                customDevice: ${{ parameters.customDevice }}
                lvVersion: ${{ lvVersion}}