# File: build-op-steps.yaml
##### Steps Template for each Build Operation #####

###########  Input Parameters for Template  ###########
parameters:
  - name: projectLocation
    type: string
  - name: buildOperation
    type: string

steps:
###########  Set lvproj Config  ###########
      # Check if lvproj config files placed for this project, if not, place the file
    - powershell: |
        $fileExists = Test-Path -Path "$(customDevice)\${{ parameters.projectLocation }}.config"
        Write-Host "##vso[task.setvariable variable=configFileExists]$fileExists"
    - ${{ eq(configFileExists, False)}}:
        # Configure build variables: lvConfigFilePath, lvCLICall
      - powershell: |
          Write-Host "##vso[task.setvariable variable=lvConfigFilePath]$(customDevice)\${{ parameters.projectLocation }}.config"
        displayName: determine config file path

        # Lvproj.config File Placement
      - script: copy "$(buildTools)\resources\LabVIEW.exe.config" "$(lvConfigFilePath)"
        displayName: Place lvproj.config next to Project
      - powershell: (Get-Content -Path '$(lvConfigFilePath)') -replace '2016.0.0.0', '$(lvConfigVersion)' | Set-Content -Path '$(lvConfigFilePath)'
        displayName: Update lvproj.config to reference correct .NET Assembly version

###########  Execute LabVIEW Build Operation  ###########
    - script: $(lvCLICall) -OperationName ${{ parameters.buildOperation }} -ProjectPath "%cd%\$(customDevice)\${{ parameters.projectLocation }}" -LogFilePath "%cd%\$(customDevice)\lvBuildSpecs.log"
      displayName: Build All Build Specs in ${{ parameters.projectLocation }} for LabVIEW $(lvVersion)
    - script: taskkill /im labview.exe /f
      displayName: Close LabVIEW $(lvVersion) Process
      condition: always() # always close LabVIEW, even if previous step fails


