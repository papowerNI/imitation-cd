parameters:
    # build step parameters are broken out as part of parameters to allow defaults to be set for individual items
  - name: buildStep
    type: object
  - name: dependencies
    type: object
    default:
      - file: ''

steps:
  - ${{ each dependency in parameters.dependencies }}: # TEMPORARY - default branchName is 'azure-pipelines' until things are actually committed to main on dependencies
    - ${{ if ne( dependency.file, '' )}}:
      - task: PowerShell@2
        displayName: Copy dependency ${{ dependency.file }} to ${{ dependency.destination }}
        inputs:
          targetType: 'inline'
          script: |
            Write-Output "Configuring target directory environment..."
            If ('${{ parameters.buildStep.target }}' -eq 'My Computer')
            {
              Write-Output "##vso[task.setvariable variable=dependencyTargetDirectory]Windows"
            }
            If ('${{ parameters.buildStep.target }}' -eq 'Linux x64')
            {
              Write-Output "##vso[task.setvariable variable=dependencyTargetDirectory]Linux_x64"
            }
            `
            Write-Output "Checking for development branch path at $(Build.SourceBranchName)..."
            $branchName = 'main'
            If (Test-Path -Path "${{ dependency.source }}\NI\export\$(Build.SourceBranchName)\*\$(lvVersion)\$(architecture)") 
            {
              Write-Output "branch path found, using $(Build.SourceBranchName) instead of $branchName"
              $branchName = '$(Build.SourceBranchName)'
            }
            `
            Write-Output "Finding latest successful build of dependency..."
            $allDependencyBuilds = Get-ChildItem `
              -Path "${{ dependency.source }}\NI\export\$branchName\*" `
              | Sort {$_.Name} -Descending
            Foreach ($build in $allDependencyBuilds)
            {
              If((Test-Path -Path "$build\$(lvVersion)\$(architecture)\.finished"))
              {
                $dependencyFilePath = "$build\$(lvVersion)\$(architecture)\$(dependencyTargetDirectory)\${{ dependency.file }}"
                Break
              }
            }
            `
            Write-Output "Copying dependency..."
            If (-not(Test-Path -Path '$(customDeviceRepoName)\${{ dependency.destination }}'))
            {
              New-Item `
                -Path '$(customDeviceRepoName)\${{ dependency.destination }}' `
                -ItemType 'Directory'
            }
            Copy-Item `
              -Path $dependencyFilePath `
              -Destination '$(customDeviceRepoName)\${{ dependency.destination }}\' `
              -Recurse `
              -Force

  - task: PowerShell@2
    displayName: Prepare to build ${{ parameters.buildStep.buildSpec }} on ${{ parameters.buildStep.target }} in ${{ parameters.buildStep.projectLocation }}
    inputs:
      targetType: 'inline'
      script: |
        Write-Output "Add LabVIEW config file if needed..."
        If (-not(Test-Path -Path "$(customDeviceRepoName)\${{ parameters.buildStep.projectLocation }}.config"))
        {
          $lvConfigFilePath = '$(customDeviceRepoName)\${{ parameters.buildStep.projectLocation }}.config'
          Copy-Item "$(buildTools)\resources\LabVIEW.exe.config" -Destination $lvConfigFilePath
          (Get-Content -Path $lvConfigFilePath) -replace '2016.0.0.0', '$(lvConfigVersion)' | Set-Content -Path $lvConfigFilePath
        }
        `
        Write-Output "Set target and buildSpec arguments if needed..."
        If ('${{ parameters.buildStep.target }}' -eq 'All')
        {
          Write-Host '##vso[task.setvariable variable=targetArgument]'
        } 
        Else
        {
          Write-Host '##vso[task.setvariable variable=targetArgument]-TargetName "${{ parameters.buildStep.target }}" '
        }
        If ('${{ parameters.buildStep.buildSpec }}' -eq 'All')
        {
          Write-Host '##vso[task.setvariable variable=buildSpecArgument]'
        }
        Else
        {
          Write-Host '##vso[task.setvariable variable=buildSpecArgument]-BuildSpecName "${{ parameters.buildStep.buildSpec }}" '
        }

  - task: CmdLine@2
    displayName: Build ${{ parameters.buildStep.buildSpec }} on ${{ parameters.buildStep.target }} in ${{ parameters.buildStep.projectLocation }}
    inputs:
      script: |
        echo on
        $(lvCLICall) ^
          -OperationName "${{ parameters.buildStep.buildOperation }}" ^
          -ProjectPath "%cd%\$(customDeviceRepoName)\${{ parameters.buildStep.projectLocation }}" ^
          $(targetArgument) ^
          $(buildSpecArgument) ^
          -LogFilePath "%cd%\$(customDeviceRepoName)\lvBuildSpecs.log"
    

  - task: CmdLine@2
    displayName: Close LabVIEW
    condition: always() # close LabVIEW even if previous steps failed
    inputs:
      script: taskkill /im labview.exe /f
    

