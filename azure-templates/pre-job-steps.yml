parameters:
  - name: lvVersionToBuild
    type: object
  - name: releaseInfo
    type: object

steps:
  - task: PowerShell@2
    displayName: Configure Job-wide Variables for LabVIEW ${{ parameters.lvVersionToBuild.version }} ${{ parameters.lvVersionToBuild.bitness }}
    inputs: 
      targetType: 'inline'
      script: |
        Write-Host '##vso[task.setvariable variable=buildTools]niveristand-custom-device-build-tools'
        $customDeviceRepoName = '$(Build.Repository.Name)' -replace '.+\/', ''
        Write-Host "##vso[task.setvariable variable=customDeviceRepoName]$customDeviceRepoName"
        Write-Output "Defining repository variables..."
        `
        Write-Host '##vso[task.setvariable variable=releaseVersion]${{ parameters.releaseInfo.releaseVersion }}'
        Write-Host '##vso[task.setvariable variable=quarterlyReleaseVersion]${{ parameters.releaseInfo.quarterlyReleaseVersion }}'
        Write-Output 'Configuring release version...'
        `
        Write-Host '##vso[task.setvariable variable=lvVersion]${{ parameters.lvVersionToBuild.version }}'
        If ('${{ parameters.lvVersionToBuild.bitness }}' -eq '32-bit')
        {
          Write-Host '##vso[task.setvariable variable=lvPath]C:\Program Files (x86)\National Instruments\LabVIEW $(lvVersion)'
          Write-Host '##vso[task.setvariable variable=architecture]x86'
          Write-Host '##vso[task.setvariable variable=nipkgx86suffix]-x86'
          Write-Host '##vso[task.setvariable variable=nipkgx64suffix]'
        }
        If ('${{ parameters.lvVersionToBuild.bitness }}' -eq '64-bit')
        {
          Write-Host '##vso[task.setvariable variable=lvPath]C:\Program Files\National Instruments\LabVIEW $(lvVersion)'
          Write-Host '##vso[task.setvariable variable=architecture]x64'
          Write-Host '##vso[task.setvariable variable=nipkgx86suffix]'
          Write-Host '##vso[task.setvariable variable=nipkgx64suffix]64'
        }     
        Write-Host '##vso[task.setvariable variable=lvCLICall]LabVIEWCLI -PortNumber 3363 -LabVIEWPath "$(lvPath)\LabVIEW.exe" -AdditionalOperationDirectory "%cd%\$(buildTools)\lv\operations"'
        Write-Output 'Configuring to build for LabVIEW $(lvVersion) ${{ parameters.lvVersionToBuild.bitness }}...'
        `
        If ('$(lvVersion)' -eq '2020')
        {
          Write-Host '##vso[task.setvariable variable=lvConfigVersion]8.0.0.0'
          Write-Host '##vso[task.setvariable variable=shortLvVersion]20'
        }
        If ('$(lvVersion)' -eq '2021')
        {
          Write-Host '##vso[task.setvariable variable=lvConfigVersion]9.0.0.0'
          Write-Host '##vso[task.setvariable variable=shortLvVersion]21'
        }
        If ('$(lvVersion)' -eq '2023')
        {
          Write-Host '##vso[task.setvariable variable=lvConfigVersion]10.0.0.0'
          Write-Host '##vso[task.setvariable variable=shortLvVersion]23'
        }
        Write-Output 'Using .NET Assembly ${lvConfigVersion)...'

  - checkout: self
    displayName: Check out repository to build

  - checkout: niveristand-custom-device-build-tools
    displayName: Check out NI VS Custom Device Build Tools repository

  - task: CmdLine@2
    displayName: Clear compiled cache for LabVIEW ${{ parameters.lvVersionToBuild.version }}
    inputs:
      script: $(lvCLICall) -OperationName "SecureRunVI" -VIPath "%cd%\$(buildTools)\lv\operations\Utilities\ClearCache.vi" -LogFilePath "%cd%\$(customDeviceRepoName)\lvClearCache.log"