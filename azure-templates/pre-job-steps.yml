parameters:
  - name: customDeviceRepoName
    type: string
  - name: lvVersion
    type: string
  - name: bitness
    type: string
  - name: releaseVersion
    type: string
  - name: quarterlyReleaseVersion
    type: string
  - name: buildTools
    type: string
    default: niveristand-custom-device-build-tools


steps:
  - task: PowerShell@2
    displayName: Configure Job-wide Variables for LabVIEW ${{ parameters.lvVersion }} ${{ parameters.bitness }}
    inputs: 
      targetType: 'inline'
      failOnStderr: true
      script: |
        Write-Host '##vso[task.setvariable variable=buildTools]${{ parameters.buildTools }}'
        Write-Output "Available variables..."
        Write-Output "Build.Repository.Name: $(Build.Repository.Name)"
        Write-Output "Pipeline.Workspace: $(Pipeline.Workspace)"
        Write-Output "Agent.BuildDirectory: $(Agent.BuildDirectory)"
        Write-Output "Build.Repository.LocalPath: $(Build.Repository.LocalPath)"
        Write-Host '##vso[task.setvariable variable=customDeviceRepoName]${{ parameters.customDeviceRepoName }}'
        Write-Output "Defining repository variables..."
        `
        Write-Host '##vso[task.setvariable variable=releaseVersion]${{ parameters.releaseVersion }}'
        Write-Host '##vso[task.setvariable variable=quarterlyReleaseVersion]${{ parameters.quarterlyReleaseVersion }}'
        Write-Output "Configuring release version..."
        `
        Write-Host '##vso[task.setvariable variable=lvVersion]${{ parameters.lvVersion }}'
        If (eq('${{ parameters.bitness }}', '32-bit'))
        {
          Write-Host "##vso[task.setvariable variable=lvPath]C:\Program Files (x86)\National Instruments\LabVIEW $(lvVersion)"
          Write-Host "##vso[task.setvariable variable=architecture]x86"
          Write-Host "##vso[task.setvariable variable=nipkgx86suffix]-x86"
          Write-Host "##vso[task.setvariable variable=nipkgx64suffix]"
        }
        If (eq('${{ parameters.bitness }}', '64-bit'))
        {
          Write-Host "##vso[task.setvariable variable=lvPath]C:\Program Files\National Instruments\LabVIEW $(lvVersion)"
          Write-Host "##vso[task.setvariable variable=architecture]x64"
          Write-Host "##vso[task.setvariable variable=nipkgx86suffix]"
          Write-Host "##vso[task.setvariable variable=nipkgx64suffix]64"
        }     
        Write-Output "Configuring to build for LabVIEW $(lvVersion) ${{ parameters.bitness }}..."
        `
        If (eq('$(lvVersion)', '2020'))
        {
          Write-Host '##vso[task.setvariable variable=lvConfigVersion]8.0.0.0'
          Write-Host '##vso[task.setvariable variable=shortLvVersion]20'
        }
        If (eq('$(lvVersion)', '2021'))
        {
          Write-Host '##vso[task.setvariable variable=lvConfigVersion]9.0.0.0'
          Write-Host '##vso[task.setvariable variable=shortLvVersion]21'
        }
        If (eq('$(lvVersion)', '2023'))
        {
          Write-Host '##vso[task.setvariable variable=lvConfigVersion]10.0.0.0'
          Write-Host '##vso[task.setvariable variable=shortLvVersion]23'
        }
        Write-Output "Using .NET Assembly ${lvConfigVersion)..."

  - powershell: Write-Host '##vso[task.setvariable variable=lvCLICall]LabVIEWCLI -PortNumber 3363 -LabVIEWPath "$(lvPath)\LabVIEW.exe" -AdditionalOperationDirectory "%cd%\$(buildTools)\lv\operations"'

  - checkout: self
    displayName: Check out ${{ parameters.customDeviceRepoName }} repository

  - checkout: ${{ parameters.buildTools }}
    displayName: Check out NI VS Custom Device Build Tools repository

  - script: $(lvCLICall) -OperationName "SecureRunVI" -VIPath "%cd%\$(buildTools)\lv\operations\Utilities\ClearCache.vi" -LogFilePath "%cd%\$(customDeviceRepoName)\lvClearCache.log"
    displayName: Clear compiled cache for LabVIEW ${{ parameters.lvVersion }}