parameters:
  - name: buildOutputLocation
    type: string
  - name: archiveLocation
    type: string
  - name: pack
    type: boolean
    default: false

steps:
###########  Archive  ###########
  - ${{ if eq( parameters.pack, true )}}:
    - powershell: Write-Host "##vso[task.setvariable variable=nipkgPath]$(customDeviceRepoName)\nipkg"
      displayName: set nipkg path variable
    - powershell: |
        If (Test-Path "$(nipkgPath)") { Remove-Item -Path "$(nipkgPath)" -Recurse -Force }
        New-Item -Path "$(nipkgPath)" -Name "control" -ItemType "Directory"
        New-Item -Path "$(nipkgPath)" -Name "data" -ItemType "Directory"
        New-Item -Path "$(nipkgPath)" -Name "debian-binary"
        Set-Content "$(nipkgPath)\debian-binary" '2.0\n'
        Copy-Item -Path "$(customDeviceRepoName)\control" -Destination "$(nipkgPath)\control"
      displayName: stage nipkg directory
    - powershell: |
        $lvConfigFilePath = '$(customDeviceRepoName)\${{ parameters.projectLocation }}.config'
        Copy-Item "$(buildTools)\resources\LabVIEW.exe.config" -Destination $lvConfigFilePath
        (Get-Content -Path $(nipkgPath)\control) -replace '{veristand_version}', '$(lvVersion)'
        (Get-Content -Path $(nipkgPath)\control) -replace '{labview_version}', '$(lvVersion)'
        (Get-Content -Path $(nipkgPath)\control) -replace '{nipkg_version}', '$(releaseVersion)'
        (Get-Content -Path $(nipkgPath)\control) -replace '{quarterly_display_version}', '$(quarterlyReleaseVersion)'
        (Get-Content -Path $(nipkgPath)\control) -replace '{labview_short_version}', '$(shortLvVersion)'
        Set-Content -Path $lvConfigFilePath
        displayName: Update control version parameters
    - script: echo "this is incomplete"
      displayName: Pack nipkg (INCOMPLETE)
  - powershell: |
      Copy-Item `
      -Path "$(customDeviceRepoName)\${{ parameters.buildOutputLocation }}\*" `
      -Destination "${{ parameters.archiveLocation }}\NI\export\$(Build.SourceBranchName)\$(Build.BuildId)\$(lvVersion)\$(architecture)\" `
      -Recurse
    displayName: Copying built files to nirvana Archive